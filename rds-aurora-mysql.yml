# aws cloudformation create-stack --stack-name rds-aurora-mysql-us-east-1-demo --template-body file://rds-aurora-mysql.yml

AWSTemplateFormatVersion: '2010-09-09'

Description: >
  This template creates a RDS Aurora MySQL Database and also utilizes Secrets Manager.

Parameters:
  DeploymentId:
    Type: String
    Description: A unique deployment identifier.
    Default: demo

  Owner:
    Type: String
    Description: Email address of the person that created the stack.
    Default: jason@moskowitz.sh

  Service:
    Type: String
    Description: Name of the service or product that is associated with this stack.
    Default: aurora-mysql

  RdsAuroraMySqlDatabaseName:
    Type: String
    Description: RDS database name.
    Default: demo

  RdsAuroraMySqlInstanceType:
    Description: RDS EC2 instance type
    Type: String
    Default: db.t2.micro

# The Resources section specifies the resources and their properties deployed in the stack.
Resources:
### RDS Aurora MySQL Database ###
  RdsAuroraMySqlSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: EES RDS Subnet Group
      SubnetIds:
        - !ImportValue 'DatabaseSubnetAz1'
        - !ImportValue 'DatabaseSubnetAz2'
      Tags:
        - Key: Name
          Value: !Sub rds-${Service}-${DeploymentId}
        - Key: Service
          Value: !Ref 'Service'
        - Key: Owner
          Value: !Ref 'Owner'

  RdsAuroraMySqlSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDS Security Group
      VpcId: !ImportValue 'VpcId'
      Tags:
        - Key: Name
          Value: !Sub rds-${Service}-${DeploymentId}
        - Key: Service
          Value: !Ref 'Service'
        - Key: Owner
          Value: !Ref 'Owner'

  RdsAuroraMySqlSecurityGroup3306Inbound:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref 'RdsAuroraMySqlSecurityGroup'
      IpProtocol: tcp
      FromPort: '3306'
      ToPort: '3306'
      CidrIp: 10.19.0.0/24

  RdsAuroraMySqlDbInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      AllocatedStorage: 20
      DBInstanceClass: !Ref 'RdsAuroraMySqlInstanceType'
      DBInstanceIdentifier: !Join ['-', [ !Ref 'Service', rds, !Ref 'AWS::Region', !Ref 'DeploymentId']]
      DBName: !Ref 'RdsAuroraMySqlDatabaseName'
      DBSubnetGroupName: !Ref 'RdsAuroraMySqlSubnetGroup'
      Engine: aurora
      #EngineVersion: 5.6.40
      MasterUsername: !Join ['', ['{{resolve:secretsmanager:', !Ref RdsAuroraMySqlDbSecret, ':SecretString:username}}' ]]
      MasterUserPassword: !Join ['', ['{{resolve:secretsmanager:', !Ref RdsAuroraMySqlDbSecret, ':SecretString:password}}' ]]      
      MultiAZ: true
      PreferredBackupWindow: 06:00-06:30
      PreferredMaintenanceWindow: Wed:07:00-Wed:08:00
      PubliclyAccessible: false
      StorageEncrypted: false
      StorageType: gp2
      Tags:
        - Key: Name
          Value: !Sub rds-${Service}-${DeploymentId}
        - Key: Service
          Value: !Ref 'Service'
        - Key: Owner
          Value: !Ref 'Owner'
      VPCSecurityGroups:
        - !Ref 'RdsAuroraMySqlSecurityGroup'

### Secrets Manager ###
  RdsAuroraMySqlDbSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: "Dynamically generated secret password."
      GenerateSecretString:
        SecretStringTemplate: '{"username": "admin"}'
        GenerateStringKey: "password"
        PasswordLength: 16
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Name
          Value: !Sub rds-${Service}-${DeploymentId}
        - Key: Service
          Value: !Ref 'Service'
        - Key: Owner
          Value: !Ref 'Owner'

  SecretRDSInstanceAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref RdsAuroraMySqlDbSecret
      TargetId: !Ref RdsAuroraMySqlDbInstance
      TargetType: AWS::RDS::DBInstance

Outputs:
  RdsAuroraMySqlDbInstanceUrl:
    Description: RDS Aurora MySQL Database URL
    Value: !GetAtt [RdsAuroraMySqlDbInstance, Endpoint.Address]
    Export:
      Name: RdsAuroraMySqlDbInstanceUrl

  RdsAuroraMySqlDbName:
    Description: RDS Aurora MySQL Database Name
    Value: !Ref 'RdsAuroraMySqlDatabaseName'
    Export:
      Name: RdsAuroraMySqlDbName
